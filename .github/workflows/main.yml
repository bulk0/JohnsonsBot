name: üöÄ –î–µ–ø–ª–æ–π –≤ Yandex Cloud

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: üîß –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest

    steps:
      # 1. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì¶ –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
        uses: actions/checkout@v4

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å YC CLI
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å YC CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/.yc/bin" >> $GITHUB_PATH

      # 3. –õ–æ–≥–∏–Ω –≤ Yandex Cloud Container Registry
      - name: üîê Login to Yandex Cloud CR
        id: login-cr
        uses: yc-actions/yc-cr-login@v1
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SERVICE_ACCOUNT_SECRET_KEY }}

      # 4. –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å Docker –æ–±—Ä–∞–∑
      - name: üì¶ –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å Docker –æ–±—Ä–∞–∑
        env:
          CR_REGISTRY: ${{ secrets.YC_REGISTRY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t cr.yandex/$CR_REGISTRY/johnsons-bot:$IMAGE_TAG .
          docker push cr.yandex/$CR_REGISTRY/johnsons-bot:$IMAGE_TAG

      # 5. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ Serverless Containers
      - name: üöÄ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ Serverless Containers
        id: deploy-sls
        uses: yc-actions/yc-sls-container-deploy@v1
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SERVICE_ACCOUNT_SECRET_KEY }}
          container-name: johnsons-bot
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          revision-image-url: cr.yandex/${{ secrets.YC_REGISTRY }}/johnsons-bot:${{ github.sha }}
          revision-service-account-id: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
          revision-cores: 1
          revision-memory: 512Mb
          revision-core-fraction: 100
          revision-concurrency: 1
          revision-execution-timeout: 30s